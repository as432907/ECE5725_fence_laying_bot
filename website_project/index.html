<!doctype html>
<html class="no-js" lang="en">

    <head>
        <!-- meta data -->
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

        <!--font-family-->
		<link href="https://fonts.googleapis.com/css?family=Poppins:100,200,300,400,500,600,700,800,900&amp;subset=devanagari,latin-ext" rel="stylesheet">
        
        <!-- title of site -->
        <title>Hershey's Kisses Placement Robot</title>

        <!-- For favicon png --> 
		<!-- dlr_change -->
		<link rel="shortcut icon" type="image/icon" href="assets/logo/hershey_logo.jpg"/>
       
        <!--font-awesome.min.css-->
        <link rel="stylesheet" href="assets/css/font-awesome.min.css">

		<!--flat icon css-->
		<link rel="stylesheet" href="assets/css/flaticon.css">

		<!--animate.css-->
        <link rel="stylesheet" href="assets/css/animate.css">

        <!--owl.carousel.css-->
        <link rel="stylesheet" href="assets/css/owl.carousel.min.css">
		<link rel="stylesheet" href="assets/css/owl.theme.default.min.css">
		
        <!--bootstrap.min.css-->
        <link rel="stylesheet" href="assets/css/bootstrap.min.css">
		
		<!-- bootsnav -->
		<link rel="stylesheet" href="assets/css/bootsnav.css" >	
        
        <!--style.css-->
        <link rel="stylesheet" href="assets/css/style.css">
        
        <!--responsive.css-->
        <link rel="stylesheet" href="assets/css/responsive.css">
        
		<!-- For code appendix -->
		<!-- Include the Prism CSS (for styling the code blocks) -->
		<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />

		<!-- Include Prism JS (for syntax highlighting) -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
		<!-- Include the Python language support -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>


        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
		
        <!--[if lt IE 9]>
			<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
			<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->

    </head>
	
	<body>
		<!--[if lte IE 9]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
        <![endif]-->
		
		<!-- top-area Start -->
		<header class="top-area">
			<div class="header-area">
				<!-- Start Navigation -->
			    <nav class="navbar navbar-default bootsnav navbar-fixed dark no-background">

			        <div class="container">

			            <!-- Start Header Navigation -->
			            <div class="navbar-header">
			                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-menu">
			                    <i class="fa fa-bars"></i>
			                </button>
							<a class="navbar-brand" href="index.html">
								<img src="assets/logo/home.png" alt="Home Logo" class="home-logo">
							</a>
			            </div><!--/.navbar-header-->
			            <!-- End Header Navigation -->

			            <!-- Collect the nav links, forms, and other content for toggling -->
			            <div class="collapse navbar-collapse menu-ui-design" id="navbar-menu">
			                <ul class="nav navbar-nav navbar-right" data-in="fadeInDown" data-out="fadeOutUp">
			                <li class=" smooth-menu active"></li>
			                    <li class=" smooth-menu"><a href="#objective">Objective</a></li>
								<li class="smooth-menu"><a href="#demonstration-video">Video</a></li>
			                    <li class="smooth-menu"><a href="#Introduction">Introduction</a></li>
			                    <li class="smooth-menu"><a href="#Design">Design and Testing</a></li>
			                    <li class="smooth-menu"><a href="#Results">Results</a></li>
			                    <li class="smooth-menu"><a href="#Conclusion">Conclusion</a></li>
			                    <li class="smooth-menu"><a href="#futurework">Future Work</a></li>
								<li class="smooth-menu"><a href="#appendix-code">Code</a></li>
			                </ul><!--/.nav -->
			            </div><!-- /.navbar-collapse -->
			        </div><!--/.container-->
			    </nav><!--/nav-->
			    <!-- End Navigation -->
			</div><!--/.header-area-->

		    <div class="clearfix"></div>

		</header><!-- /.top-area-->
		<!-- top-area End -->
	
		<!--Project Title Welcome start -->
		<section id="welcome-hero" class="welcome-hero">
			<div class="container">
				<div class="row">
					<div class="col-md-12 text-center">
						<div class="header-text">
							<h2> Hershey's Kisses Placement Robot </h2>
							<p> ECE 5725 Final Project </p>
							presented on <p>December 12th 2024</p>
							by
							<p> Dikshanya Lashmi Ramaswamy<span>(dr655)</span> <br> Akansha Shrestha<span></span>(as4329) </p>
						</div><!--/.header-text-->
					</div><!--/.col-->
				</div><!-- /.row-->
			</div><!-- /.container-->

		</section><!--/.welcome-hero-->
		<!--welcome-hero end -->

		<!-- Objective Section Start -->
		<section id="objective" class="objective">
    		<div class="section-heading text-center">
        		<h2>Objective</h2>
				</div>
				<div class="container">
					<div class="objective-content">
						<div class="row">
							<div class="col-12">
								<div class="single-objective-txt">
									<h3>
										<!-- Write your objective here. You can describe the goals or purpose of this section in detail. -->
										The main objective of this project is to design and develop a robotic system capable of efficiently placing vertical structures, specifically traffic cones (represented by Hershey's Kisses), along a predefined path. The robot, named "Hershey's Kisses Placement Robot," utilizes a Raspberry Pi processor to navigate a course using line-following techniques and precisely position objects at designated locations
									</h3>
								</div>
							</div>
						</div>
					</div>
				</div>
			</section>
		<!-- Objective Section End -->

		<!-- Demonstration Video Section Start -->
		<section id="demonstration-video" class="demonstration-video">
			<div class="section-heading text-center">
				<h2>Demonstration Video</h2>
			</div>
			<div class="container">
				<div class="video-content">
					<div class="row">
						<div class="col-12">
							<div class="single-video">
								<!-- ADD THE YOUTUBE LINK HERE -->
								<iframe 
									src="https://www.youtube.com/embed/example" 
									title="Demonstration Video"
									frameborder="0" 
									allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
									allowfullscreen>
								</iframe>
								<div class="video-overlay">
									<p>A 2-minute video showcasing the functionality and demonstration of the Hershey's Kisses Placement Robot is available. The video highlights the robot's ability to follow a line and place chocolates at predefined intervals, illustrating its autonomous navigation and placement capabilities.</p>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>
		<!-- Demonstration Video Section End -->

		<!-- Introduction Section Start -->
		<section id="Introduction" class="objective">
			<div class="section-heading text-center">
				<h2>Introduction</h2>
				</div>
				<div class="container">
					<div class="objective-content">
						<div class="row">
							<div class="col-12">
								<div class="single-objective-txt">
									<h3>
										<!-- Write your Introductio here. You can describe the goals or purpose of this section in detail. -->
										The Hershey's Kisses Placement Robot is an embedded system that combines hardware components like a Raspberry Pi, DC motors, servo motors, and various sensors with custom software to automate the process of placing objects. The robot utilizes line-following algorithms, PID control, and real-time adjustments to ensure precise navigation and placement. A key feature of the system is a spinning disk, which stores and periodically releases chocolates, adding functionality to the placement process. This project demonstrates the principles of robotics and automation, with potential applications in larger-scale tasks such as fence installation and traffic management.
									</h3>
								</div>
							</div>
						</div>
					</div>
				</div>
			</section>
		<!-- Introduction Section End -->

		<!-- Design Section Start -->
		<section id="Design" class="objective">
			<div class="section-heading text-center">
				<h2>Design and Testing</h2>
				</div>
				<div class="container">
					<div class="objective-content">
						<div class="row">
							<div class="col-12">
								<div class="single-objective-txt">
									<h3>
										<!-- Write your Design here. You can describe the goals or purpose of this section in detail. -->
										Here the Design this project will go. 
									</h3>
								</div>
							</div>
						</div>
					</div>
				</div>
			</section>
		<!-- Design Section End -->

		<!-- Results Section Start -->
		<section id="Results" class="objective">
			<div class="section-heading text-center">
				<h2>Results</h2>
				</div>
				<div class="container">
					<div class="objective-content">
						<div class="row">
							<div class="col-12">
								<div class="single-objective-txt">
									<h3>
										<!-- Write your Results here. You can describe the goals or purpose of this section in detail. -->
										Here the Results this project will go. 
									</h3>
								</div>
							</div>
						</div>
					</div>
				</div>
			</section>
		<!-- Results Section End -->

		<!--timeline_1 start -->
		<section id="timeline_1" class="timeline_1">
			<div class="section-heading text-center">
				<h2>timeline</h2>
			</div>
			<div class="container">
				<div class="timeline_1-content">
						<div class="main-timeline">
							<ul>
								<li>
									<div class="single-timeline-box fix">
										<div class="row">
											<div class="col-md-5">
												<div class="timeline_1-time text-right">
													<h2>11/5 - 11/11</h2>
													<h3>Week0 - Project Proposal</h3>
												</div><!--/.timeline_1-time-->
											</div><!--/.col-->
											<div class="col-md-offset-1 col-md-5">
												<div class="timeline">
													<div class="timeline-content">
														<p class="description">
															This week, we plan to build upon the chassis and motor control system developed in Lab 3 by adding the photodetector array and programming it to follow markers on white tiles, where the white tiles act as light-reflecting surface and black tape as light-absorbing markers. This setup will enable the array to sense its position relative to the markers and determine how far it needs to turn to realign with the path. Additionally, we will integrate the PID sensor to improve the robot's stability and accuracy while following the markers.
														</p>
													</div><!--/.timeline-content-->
												</div><!--/.timeline-->
											</div><!--/.col-->
										</div>
									</div><!--/.single-timeline-box-->
								</li>

								<li>
									<div class="single-timeline-box fix">
										<div class="row">
											<div class="col-md-5">
												<div class="timeline_1-time text-right">
													<h2>11/12 - 11/18</h2>
													<h3>Week1 - Ideation & Design</h3>
												</div><!--/.timeline_1-time-->
											</div><!--/.col-->
											<div class="col-md-offset-1 col-md-5">
												<div class="timeline">
													<div class="timeline-content">
														<p class="description">
															This week, we plan to build upon the chassis and motor control system developed in Lab 3 by adding the photodetector array and programming it to follow markers on white tiles, where the white tiles act as light-reflecting surface and black tape as light-absorbing markers. This setup will enable the array to sense its position relative to the markers and determine how far it needs to turn to realign with the path. Additionally, we will integrate the PID sensor to improve the robot's stability and accuracy while following the markers.
														</p>
													</div><!--/.timeline-content-->
												</div><!--/.timeline-->
											</div><!--/.col-->
										</div>
									</div><!--/.single-timeline-box-->
								</li>

								<li>
									<div class="single-timeline-box fix">
										<div class="row">
											<div class="col-md-5">
												<div class="timeline_1-time text-right">
													<h2>11/19 - 11/25</h2>
													<h3>Week2 - Electrical Design</h3>
												</div><!--/.timeline_1-time-->
											</div><!--/.col-->
											<div class="col-md-offset-1 col-md-5">
												<div class="timeline">
													<div class="timeline-content">
														<p class="description">
															This week, we plan to build upon the chassis and motor control system developed in Lab 3 by adding the photodetector array and programming it to follow markers on white tiles, where the white tiles act as light-reflecting surface and black tape as light-absorbing markers. This setup will enable the array to sense its position relative to the markers and determine how far it needs to turn to realign with the path. Additionally, we will integrate the PID sensor to improve the robot's stability and accuracy while following the markers.
														</p>
													</div><!--/.timeline-content-->
												</div><!--/.timeline-->
											</div><!--/.col-->
										</div>
									</div><!--/.single-timeline-box-->
								</li>

								<li>
									<div class="single-timeline-box fix">
										<div class="row">
											<div class="col-md-5">
												<div class="timeline_1-time text-right">
													<h2>11/26 - 12/01</h2>
													<h3>Week3 - Mechanical Design</h3>
												</div><!--/.timeline_1-time-->
											</div><!--/.col-->
											<div class="col-md-offset-1 col-md-5">
												<div class="timeline">
													<div class="timeline-content">
														<p class="description">
															This week, we plan to build upon the chassis and motor control system developed in Lab 3 by adding the photodetector array and programming it to follow markers on white tiles, where the white tiles act as light-reflecting surface and black tape as light-absorbing markers. This setup will enable the array to sense its position relative to the markers and determine how far it needs to turn to realign with the path. Additionally, we will integrate the PID sensor to improve the robot's stability and accuracy while following the markers.
														</p>
													</div><!--/.timeline-content-->
												</div><!--/.timeline-->
											</div><!--/.col-->
										</div>
									</div><!--/.single-timeline-box-->
								</li>

								<li>
									<div class="single-timeline-box fix">
										<div class="row">
											<div class="col-md-5">
												<div class="timeline_1-time text-right">
													<h2>12/02 - 12/08</h2>
													<h3>Week4 - Integration</h3>
												</div><!--/.timeline_1-time-->
											</div><!--/.col-->
											<div class="col-md-offset-1 col-md-5">
												<div class="timeline">
													<div class="timeline-content">
														<p class="description">
															This week, we plan to build upon the chassis and motor control system developed in Lab 3 by adding the photodetector array and programming it to follow markers on white tiles, where the white tiles act as light-reflecting surface and black tape as light-absorbing markers. This setup will enable the array to sense its position relative to the markers and determine how far it needs to turn to realign with the path. Additionally, we will integrate the PID sensor to improve the robot's stability and accuracy while following the markers.
														</p>
													</div><!--/.timeline-content-->
												</div><!--/.timeline-->
											</div><!--/.col-->
										</div>
									</div><!--/.single-timeline-box-->
								</li>

								<li>
									<div class="single-timeline-box fix">
										<div class="row">
											<div class="col-md-5">
												<div class="timeline_1-time text-right">
													<h2>12/09 - 12/14</h2>
													<h3>Week5 - Demonstration & Report</h3>
												</div><!--/.timeline_1-time-->
											</div><!--/.col-->
											<div class="col-md-offset-1 col-md-5">
												<div class="timeline">
													<div class="timeline-content">
														<p class="description">
															This week, we plan to build upon the chassis and motor control system developed in Lab 3 by adding the photodetector array and programming it to follow markers on white tiles, where the white tiles act as light-reflecting surface and black tape as light-absorbing markers. This setup will enable the array to sense its position relative to the markers and determine how far it needs to turn to realign with the path. Additionally, we will integrate the PID sensor to improve the robot's stability and accuracy while following the markers.
														</p>
													</div><!--/.timeline-content-->
												</div><!--/.timeline-->
											</div><!--/.col-->
										</div>
									</div><!--/.single-timeline-box-->
								</li>

							</ul>
						</div><!--.main-timeline-->
					</div><!--.timeline_1-content-->
			</div>

		</section><!--/.timeline_1-->
		<!--timeline_1 end -->

		<!-- Conclusion Section Start -->
		<section id="Conclusion" class="objective">
			<div class="section-heading text-center">
				<h2>Conclusion</h2>
				</div>
				<div class="container">
					<div class="objective-content">
						<div class="row">
							<div class="col-12">
								<div class="single-objective-txt">
									<h4>
										<!-- Write your Conclusion here. You can describe the goals or purpose of this section in detail. -->
										The team strategically divided the project responsibilities to maximize efficiency and expertise. Akansha took primary responsibility for developing the line following functionality and implementing the PID (Proportional-Integral-Derivative) control algorithm, which is crucial for precise robotic navigation. 
										Simultaneously, Dikshanya focused on designing the dropping mechanism, creating the graphical user interface (GUI), and managing the overall system integration. <br>
									</h4>
									<h4>
										Throughout the project development, both team members collaborated extensively, conducting multiple rounds of experimental testing and precision mapping. 
										These collaborative efforts were directed towards fine-tuning the IR sensor positioning and optimizing the servo motor's rotational angles, ensuring the highest possible accuracy in cone placement.<br>
									</h4>
									<h4>
										The Hershey's Kisses Placement Robot ultimately represents a significant achievement in embedded systems design. By successfully integrating autonomous navigation, precise object placement, and a user-friendly interface, the team demonstrated the potential of robotic systems to automate repetitive tasks with remarkable precision. 
										The project not only showcases technical prowess but also highlights the power of collaborative engineering in solving complex robotic challenges.
									</h4>
								</div>
							</div>
						</div>
					</div>
				</div>
			</section>
		<!-- Conclusion Section End -->

		<!--gallery start -->
		<section id="gallery" class="gallery">
			<div class="gallery-details">
				<div class="section-heading text-center">
					<h2>gallery</h2>
				</div>
				<div class="container">
					<div class="gallery-content">
						<div class="isotope">
							<div class="row">

								<div class="col-sm-4">
									<div class="item">
										<img src="assets/images/gallery/p1.jpg" alt="gallery image"/>
										<div class="isotope-overlay">
											<a href="#">
												Robot Path
											</a>
										</div><!-- /.isotope-overlay -->
									</div><!-- /.item -->
									<div class="item">
										<img src="assets/images/gallery/p2.jpg" alt="gallery image"/>
										<div class="isotope-overlay">
											<a href="#">
												Motor Power Source
											</a>
										</div><!-- /.isotope-overlay -->
									</div><!-- /.item -->
								</div><!-- /.col -->

								<div class="col-sm-4">
									<div class="item">
										<img src="assets/images/gallery/p3.jpg" alt="gallery image"/>
										<div class="isotope-overlay">
											<a href="#">
												Robot Design
											</a>
										</div><!-- /.isotope-overlay -->
									</div><!-- /.item -->
								</div><!-- /.col -->

								<div class="col-sm-4">
									<div class="item">
										<img src="assets/images/gallery/p1.jpg" alt="gallery image"/>
										<div class="isotope-overlay">
											<a href="#">
												GUI
											</a>
										</div><!-- /.isotope-overlay -->
									</div><!-- /.item -->
									<div class="item">
										<img src="assets/images/gallery/p2.jpg" alt="gallery image"/>
										<div class="isotope-overlay">
											<a href="#">
												Mechanical Design
											</a>
										</div><!-- /.isotope-overlay -->
									</div><!-- /.item -->
								</div><!-- /.col -->
							</div><!-- /.row -->
						</div><!--/.isotope-->
					</div><!--/.gallery-content-->
				</div><!--/.container-->
			</div><!--/.gallery-details-->

		</section><!--/.gallery-->
		<!--gallery end -->

		<!-- Future Work Section Start -->
		<section id="futurework" class="objective">
			<div class="section-heading text-center">
				<h2>Future Work</h2>
				</div>
				<div class="container">
					<div class="objective-content">
						<div class="row">
							<div class="col-12">
								<div class="single-objective-txt">
									<h3>
										<!-- Write your Future Work here. You can describe the goals or purpose of this section in detail. -->
										Here the Future Work this project will go. 
									</h3>
								</div>
							</div>
						</div>
					</div>
				</div>
			</section>
		<!-- Future Work Section End -->

		<!--code appendix start -->
		<section id="appendix-code" class="appendix_code">
			<div class="section-heading text-center">
				<h2>Appendix - Code</h2>
			</div>
			<div class="container">
				<div class="appendix_code-content">
					<!-- GitHub Link -->
					<div class="github-link-container text-center">
						<a href="https://github.com/as432907/ECE5725_fence_laying_bot.git" class="github-link" target="_blank">
							<i class="fa fa-github"></i> View the Project on GitHub
						</a>
					</div>
					<div class="code-block">
						<div class="row">
							<div class="col-md-12">
								<div class="code-box">
									<pre><code class="language-python">
import time
import RPi.GPIO as GPIO
import pygame
import pigame
import math
import sys
import os
from pygame.locals import *

# Setup environment for the framebuffer
os.putenv('SDL_VIDEODRV', 'fbcon')
os.putenv('SDL_FBDEV', '/dev/fb0')
os.putenv('SDL_MOUSEDRV', 'dummy')
os.putenv('SDL_MOUSEDEV', '/dev/null')
os.putenv('DISPLAY', '')

# GPIO Setup
GPIO.setmode(GPIO.BCM)

# Button setup
GPIOBtns = [17, 22, 23, 27]
for button in GPIOBtns:
	GPIO.setup(button, GPIO.IN, pull_up_down=GPIO.PUD_UP)

# Servo setup
servo_pin = 24
GPIO.setup(servo_pin, GPIO.OUT)
freq = 50
dc = 2.5
servo_dc = [2.5, 4.6, 6.3, 8.4, 10.5]
servo_driver1 = GPIO.PWM(servo_pin, freq)

# Line follower setup
ENC_CENTER = 23
ENC_LEFT = 12
ENC_RIGHT = 20
GPIO.setup(ENC_CENTER, GPIO.IN, pull_up_down=GPIO.PUD_UP)
GPIO.setup(ENC_LEFT, GPIO.IN, pull_up_down=GPIO.PUD_UP)
GPIO.setup(ENC_RIGHT, GPIO.IN, pull_up_down=GPIO.PUD_UP)

# Motor setup
AI_1_pin, AI_2_pin, PWM_Apin = 5, 6, 26
BI_1_pin, BI_2_pin, PWM_Bpin = 19, 13, 16
motor_pins = [AI_1_pin, AI_2_pin, PWM_Apin, BI_1_pin, BI_2_pin, PWM_Bpin]
for pin in motor_pins:
	GPIO.setup(pin, GPIO.OUT)

pwm_driver1 = GPIO.PWM(PWM_Apin, freq)
pwm_driver2 = GPIO.PWM(PWM_Bpin, freq)
pwm_driver1.start(0)
pwm_driver2.start(0)

# Pygame Setup
pygame.init()
pitft = pigame.PiTft()
screen = pygame.display.set_mode((320, 240))
pygame.display.set_caption("Robot Cone Drop Simulation")

# Colors and Fonts
WHITE, BLACK, RED, GREEN = (255, 255, 255), (0, 0, 0), (255, 0, 0), (0, 255, 0)
font_small = pygame.font.Font(None, 20)

# Button setup
btn_start_rect = pygame.Rect(20, 60, 60, 40)
btn_stop_rect = pygame.Rect(20, 120, 60, 40)
btn_quit_rect = pygame.Rect(240, 90, 60, 40)
btn_manual_rect = pygame.Rect(130, 200, 60, 40)

# Variables
cone_count, servo_index, rotation = 0, 0, False
last_drop_time = time.time()
drop_interval = 2

# PID variables
Kp, Kd, Ki = 20, 10, 1
prev_error, integral = 0, 0

def move_servo(index):
	servo_driver1.ChangeDutyCycle(servo_dc[index])
	time.sleep(0.5)

def drop_cone():
	global servo_index, rotation
	if not rotation:
		servo_index = 0
		rotation = True
	else:
		servo_index = (servo_index + 1) % 5
	move_servo(servo_index)
	print(f"Dropped cone at {time.strftime('%H:%M:%S')} - Servo position: {servo_index + 1}")

def draw_disk(surface):
	center, outer_radius, hole_radius = (160, 120), 80, 10
	hole_offset, num_holes, initial_offset = outer_radius - 15, 5, 270
	pygame.draw.circle(surface, BLACK, center, outer_radius, 2)
	for i in range(num_holes):
		angle = (initial_offset - i * (180 / (num_holes - 1))) % 360
		x = center[0] + hole_offset * math.cos(math.radians(angle))
		y = center[1] - hole_offset * math.sin(math.radians(angle))
		color = RED if i == servo_index else WHITE
		pygame.draw.circle(surface, color, (int(x), int(y)), hole_radius)
		pygame.draw.circle(surface, BLACK, (int(x), int(y)), hole_radius, 2)
		hole_number_text = font_small.render(str(i + 1), True, BLACK)
		surface.blit(hole_number_text, hole_number_text.get_rect(center=(int(x), int(y))))
	pygame.draw.circle(surface, RED, center, 5)

def draw_buttons():
	for btn, text in zip([btn_start_rect, btn_stop_rect, btn_quit_rect, btn_manual_rect], ['START', 'STOP', 'QUIT', 'Manual Drop']):
		pygame.draw.rect(screen, WHITE, btn)
		text_surf = font_small.render(text, True, BLACK)
		screen.blit(text_surf, text_surf.get_rect(center=btn.center))

def move_robot(timeout, drop_interval):
	global prev_error, integral, servo_index, rotation, motor_running, last_drop_time
	start_time = time.time()
	last_drop_time = time.time()
	while time.time() - start_time < timeout:
		if not GPIO.input(GPIOBtns[3]):
			print("Quitting Program")
			code_running = False   
			time.sleep(0.2)
		screen.fill(WHITE)
		draw_disk(screen)
		draw_buttons()
		pitft.update()
		for event in pygame.event.get():
			if event.type == pygame.MOUSEBUTTONDOWN:
				x, y = event.pos
				if btn_stop_rect.collidepoint(x, y):
					motor_running = False
					stop_motor()
					last_drop_time = time.time()  # Reset the timer
				elif btn_start_rect.collidepoint(x, y):
					motor_running = True
				elif btn_manual_rect.collidepoint(x, y):
					drop_cone()
				elif btn_quit_rect.collidepoint(x, y):
					return False

		if motor_running:
			if not GPIO.input(GPIOBtns[3]):
				print("Quitting Program")
				return False   
				time.sleep(0.2)
			# Line following logic (unchanged)
			if GPIO.input(ENC_CENTER) == GPIO.HIGH and GPIO.input(ENC_RIGHT) == GPIO.LOW and GPIO.input(ENC_LEFT) == GPIO.LOW:
				print("Black line detected")
				error = 0
				pwm_driver1.ChangeDutyCycle(50)
				pwm_driver2.ChangeDutyCycle(50)
				GPIO.output(AI_1_pin, GPIO.HIGH)
				GPIO.output(AI_2_pin, GPIO.LOW)
				GPIO.output(BI_1_pin, GPIO.HIGH)
				GPIO.output(BI_2_pin, GPIO.LOW)
				prev_error = error
			elif GPIO.input(ENC_CENTER) == GPIO.LOW and GPIO.input(ENC_LEFT) == GPIO.HIGH and GPIO.input(ENC_RIGHT) == GPIO.LOW:
				print("Moving RIGHT")
				error = -1
				integral = max(min(integral + error, 100), -100)
				pid = Kp * error + Kd * (error - prev_error) + Ki * integral
				dc_A = max(0, min(100, 25 + pid))
				dc_B = max(0, min(100, 25 - pid))
				pwm_driver1.ChangeDutyCycle(dc_A)
				pwm_driver2.ChangeDutyCycle(dc_B)
				GPIO.output(AI_1_pin, GPIO.HIGH)
				GPIO.output(AI_2_pin, GPIO.LOW)
				GPIO.output(BI_1_pin, GPIO.HIGH)
				GPIO.output(BI_2_pin, GPIO.LOW)
				prev_error = error
			elif GPIO.input(ENC_CENTER) == GPIO.LOW and GPIO.input(ENC_RIGHT) == GPIO.HIGH and GPIO.input(ENC_LEFT) == GPIO.LOW:
				print("Moving LEFT")
				error = 1
				integral = max(min(integral + error, 100), -100)
				pid = Kp * error + Kd * (error - prev_error) + Ki * integral
				dc_A = max(0, min(100, 25 + pid))
				dc_B = max(0, min(100, 25 - pid))
				pwm_driver1.ChangeDutyCycle(dc_A)
				pwm_driver2.ChangeDutyCycle(dc_B)
				GPIO.output(AI_1_pin, GPIO.HIGH)
				GPIO.output(AI_2_pin, GPIO.LOW)
				GPIO.output(BI_1_pin, GPIO.HIGH)
				GPIO.output(BI_2_pin, GPIO.LOW)
				prev_error = error
			elif GPIO.input(ENC_CENTER) == GPIO.LOW and GPIO.input(ENC_RIGHT) == GPIO.LOW and GPIO.input(ENC_LEFT) == GPIO.LOW:
				print("Moving BACKWARD")
				pwm_driver1.ChangeDutyCycle(40)
				pwm_driver2.ChangeDutyCycle(40)
				GPIO.output(AI_1_pin, GPIO.LOW)
				GPIO.output(AI_2_pin, GPIO.HIGH)
				GPIO.output(BI_1_pin, GPIO.LOW)
				GPIO.output(BI_2_pin, GPIO.HIGH)

			# Drop cone logic
			if time.time() - last_drop_time >= drop_interval:
				last_drop_time = time.time()
				pwm_driver1.ChangeDutyCycle(0)
				pwm_driver2.ChangeDutyCycle(0)
				drop_cone()
				time.sleep(1)
		pygame.display.flip()
		time.sleep(0.1)

	return True


def stop_motor():
	pwm_driver1.ChangeDutyCycle(0)
	pwm_driver2.ChangeDutyCycle(0)
	GPIO.output(AI_1_pin, GPIO.LOW)  # Stop motor A
	GPIO.output(AI_2_pin, GPIO.LOW)
	GPIO.output(BI_1_pin, GPIO.LOW)  # Stop motor B
	GPIO.output(BI_2_pin, GPIO.LOW)
	print("Motors stopped.")

# ----------------------- MAIN FUNCTION ---------------------------------------------------


print("Starting the simulation... Press Ctrl+C to quit.")
code_running = True
motor_running = False
servo_driver1.start(dc)


while code_running:
	screen.fill(WHITE)
	draw_disk(screen)
	draw_buttons()
	pitft.update()
	
	if not GPIO.input(GPIOBtns[3]):
		print("Quitting Program")
		code_running = False   
		time.sleep(0.2)
	
	for event in pygame.event.get():
		if event.type == pygame.QUIT:
			raise KeyboardInterrupt
		elif event.type == pygame.MOUSEBUTTONDOWN:
			x, y = event.pos
			if btn_start_rect.collidepoint(x, y):
				print("Simulation started. Moving and dropping cones.")
				motor_running = True
				code_running = move_robot(timeout=600, drop_interval=5)  # 10 minutes timeout, drop every 5 seconds
			elif btn_stop_rect.collidepoint(x, y):
				motor_running = False
				stop_motor()
			elif btn_quit_rect.collidepoint(x, y):
				code_running = False
			elif btn_manual_rect.collidepoint(x, y):
				drop_cone()

	pygame.display.flip()


print("Exiting the simulation. Goodbye!")
servo_driver1.stop()
pwm_driver1.stop()
pwm_driver2.stop()
GPIO.cleanup()
pygame.quit()
del pitft
sys.exit()
								</code></pre>
							</div><!--/.code-box-->
						</div><!--/.col-->
					</div><!--/.row-->
				</div><!--/.code-block-->
			</div><!--.appendix_code-content-->
		</div><!--/.container-->
		</section><!--/.appendix_code-->
		<!-- appendix code end -->

		<!-- Reference start -->
		<section id="references" class="references">
			<div class="container">
				<div class="section-heading">
					<h2>References</h2>
				</div>
				<ol class="references-list">
					<li>
						<span>Linear transfer system - LCM - TAKTOMAT GmbH</span> - for presses / industrial / for the construction industry
					</li>
					<li>
						<a href="https://www.adiy.in/product/lm393-comparator-module">Buy LM393 - Comparator Module online at Adiy.in</a>
					</li>
					<li>
						<a href="https://components101.com/ics/lm393-comparator-ic">LM393 IC : Pin Configuration, Circuit Diagram & Its Working</a>
					</li>
					<li>
						<a href="https://www.vishay.com/docs/83760/tcrt5000.pdf">Reflective Optical Sensor with Transistor Output TCRT5000, TCRT5000L</a>
					</li>
					<li>
						<a href="https://www.themesine.com">Website Template - Shop - ThemeSINE</a>
					</li>
					<li>
						<a href="https://www.amazon.com/Smart-Robot-Chassis-Motors-Encoder/dp/B07X9H6PHV">
							Amazon.com: Emo Smart Robot Car Chassis Kit with Motors, Speed Encoder and Battery Box for DIY
						</a>
					</li>
					<li>
						<a href="https://www.distrelec.com/en/rpi4-case-red-white-bulk-raspberry-pi-4-enclosure-raspberry-white/p/30018925">
							RPI4 CASE RED/WHITE BULK | Raspberry Pi 4 Enclosure, Raspberry / White | Distrelec International
						</a>
					</li>
				</ol>
			</div>
		</section>
		<!-- Reference end -->
		
		<!--footer-copyright start-->
		<footer id="footer-copyright" class="footer-copyright">
			<div class="container">
				<div class="hm-footer-copyright text-center">
					<p>
						&copy; copyright Dikshanya & Akansha. design and developed by <a href="https://www.themesine.com/">themesine</a>
					</p><!--/p-->
				</div><!--/.text-center-->
			</div><!--/.container-->

			<div id="scroll-Top">
				<div class="return-to-top">
					<i class="fa fa-angle-up " id="scroll-top" ></i>
				</div>
				
			</div><!--/.scroll-Top-->
			
        </footer><!--/.footer-copyright-->
		<!--footer-copyright end-->
		
		<!-- Include all js compiled plugins (below), or include individual files as needed -->

		<script src="assets/js/jquery.js"></script>
        
        <!--modernizr.min.js-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>
		
		<!--bootstrap.min.js-->
        <script src="assets/js/bootstrap.min.js"></script>
		
		<!-- bootsnav js -->
		<script src="assets/js/bootsnav.js"></script>
		
		<!-- jquery.sticky.js -->
		<script src="assets/js/jquery.sticky.js"></script>
		
		<!-- for progress bar start-->

		<!-- progressbar js -->
		<script src="assets/js/progressbar.js"></script>

		<!-- appear js -->
		<script src="assets/js/jquery.appear.js"></script>

		<!-- for progress bar end -->

		<!--owl.carousel.js-->
        <script src="assets/js/owl.carousel.min.js"></script>


		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.min.js"></script>
		
        
        <!--Custom JS-->
        <script src="assets/js/custom.js"></script>
        
    </body>
	
</html>